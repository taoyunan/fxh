<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Steam 拼图工具</title>
<style>
  body { margin:0; padding:0; background:#121417; color:#e0e0e0; font-family:sans-serif; text-align:center; }
  #canvas-container { margin:20px auto; border:2px solid #333; width:1200px; height:278px; position:relative; }
  canvas { display:block; }
</style>
</head>
<body>

<h1>Steam 拼图工具</h1>

<div>
  <input id="appId" placeholder="请输入 Steam App ID，例如：2962810" />
  <button id="fetchBtn">获取并合成</button>
  <button id="saveBtn" disabled>保存图片</button>
</div>

<div id="canvas-container">
  <canvas id="heroCanvas" width="1200" height="278"></canvas>
</div>

<div>
  <label for="scaleSlider">缩放 Logo:</label>
  <input type="range" id="scaleSlider" min="10" max="200" value="100" disabled />
  <span id="scalePercent">100%</span>
</div>
<div>
  <label for="overlaySlider">背景渐变黑:</label>
  <input type="range" id="overlaySlider" min="0" max="100" value="40" />
  <span id="overlayPercent">40%</span>
</div>

<div id="loading"></div>
<div id="error"></div>

<script>
  const canvas = document.getElementById('heroCanvas');
  const ctx = canvas.getContext('2d');
  const appIdInput = document.getElementById('appId');
  const fetchBtn = document.getElementById('fetchBtn');
  const saveBtn = document.getElementById('saveBtn');
  const scaleSlider = document.getElementById('scaleSlider');
  const scalePercent = document.getElementById('scalePercent');
  const overlaySlider = document.getElementById('overlaySlider');
  const overlayPercent = document.getElementById('overlayPercent');
  const errorBox = document.getElementById('error');
  const loadingBox = document.getElementById('loading');

  let heroImg = new Image();
  let logoImg = new Image();
  heroImg.crossOrigin = 'anonymous';
  logoImg.crossOrigin = 'anonymous';

  let heroLoaded = false;
  let logoLoaded = false;
  let logoX = 40, logoY = 40, logoScale = 1;
  let overlayOpacity = 0.4;

  function setLoading(msg){ loadingBox.textContent = msg || ''; }
  function setError(msg){ errorBox.textContent = msg || ''; }

  function drawHero(){
    if(!heroLoaded) return;
    const cw = canvas.width, ch = canvas.height;
    ctx.clearRect(0,0,cw,ch);
    const scale = Math.max(cw/heroImg.width, ch/heroImg.height);
    const w = heroImg.width*scale, h = heroImg.height*scale;
    ctx.drawImage(heroImg,(cw-w)/2,(ch-h)/2,w,h);
    if(overlayOpacity>0){
      const g = ctx.createLinearGradient(0,0,0,ch);
      g.addColorStop(0,`rgba(0,0,0,${overlayOpacity})`);
      g.addColorStop(1,`rgba(0,0,0,0)`);
      ctx.fillStyle=g;
      ctx.fillRect(0,0,cw,ch);
    }
  }

  function drawLogo(){
    if(!logoLoaded) return;
    const w=logoImg.width*logoScale;
    const h=logoImg.height*logoScale;
    ctx.drawImage(logoImg,logoX,logoY,w,h);
  }

  function drawAll(){
    drawHero();
    drawLogo();
  }

  function loadImageWithFallback(img,urls,done){
    let i=0;
    const next=()=>{
      if(i>=urls.length){done(false);return;}
      const url=urls[i++];
      img.onload=()=>done(true);
      img.onerror=()=>next();
      img.src=url;
    };
    next();
  }

  function loadForApp(appId){
    setError(''); setLoading('加载中…');
    heroLoaded=logoLoaded=false;
    scaleSlider.disabled=true;
    saveBtn.disabled=true;

    const heroCandidates=[
      `https://api.steamcmd.net/v1/info/${appId}/library_hero.jpg`,
      `https://api.steamcmd.net/v1/info/${appId}/library_hero_2x.jpg`,
      `https://api.steamcmd.net/v1/info/${appId}/capsule_616x353.jpg`,
      `https://api.steamcmd.net/v1/info/${appId}/header.jpg`
    ];

    const logoCandidates=[
      `https://api.steamcmd.net/v1/info/${appId}/logo.png`,
      `https://api.steamcmd.net/v1/info/${appId}/header.jpg`
    ];

    loadImageWithFallback(heroImg,heroCandidates,ok=>{
      heroLoaded=ok; setLoading('');
      if(!ok) setError('背景图加载失败');
      drawAll();
      if(heroLoaded&&logoLoaded) saveBtn.disabled=false;
    });

    loadImageWithFallback(logoImg,logoCandidates,ok=>{
      logoLoaded=ok;
      if(!ok) setError('Logo 加载失败');
      logoScale=1;
      if(logoImg.height){
        const targetH=120;
        logoScale=Math.min(2,Math.max(0.2,targetH/logoImg.height));
      }
      logoX=40; logoY=(canvas.height-logoImg.height*logoScale)/2;
      scaleSlider.value=Math.round(logoScale*100);
      scaleSlider.disabled=!ok;
      scalePercent.textContent=`${Math.round(logoScale*100)}%`;
      drawAll();
      if(heroLoaded&&logoLoaded) saveBtn.disabled=false;
    });
  }

  fetchBtn.addEventListener('click',()=>{
    const id=(appIdInput.value||'').trim();
    if(!id){ setError('请输入有效的 App ID'); return; }
    loadForApp(id);
  });

  saveBtn.addEventListener('click',()=>{
    canvas.toBlob(blob=>{
      if(!blob){ setError('导出失败'); return; }
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url; a.download=`steam_hero_${Date.now()}.png`;
      a.click();
      URL.revokeObjectURL(url);
    });
  });

  scaleSlider.addEventListener('input',e=>{
    logoScale=(parseInt(e.target.value,10)||100)/100;
    scalePercent.textContent=`${Math.round(logoScale*100)}%`;
    drawAll();
  });

  overlaySlider.addEventListener('input',e=>{
    overlayOpacity=(parseInt(e.target.value,10)||0)/100;
    overlayPercent.textContent=`${Math.round(overlayOpacity*100)}%`;
    drawAll();
  });

  // 默认加载示例
  (function init(){ loadForApp('2962810'); })();
</script>
</body>
</html>
